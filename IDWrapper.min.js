!function(e,t){"use strict";"function"==typeof define&&define.amd?define([],function(){return e.IDBWrapper=t()}):"object"==typeof module&&module.exports?module.exports=t():e.IDBWrapper=t()}(this,function(){var e=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,t=window.Promise;if(!e)throw new Error("Your browser is not support indexedDB");if("object"!=typeof window||"object"!=typeof window.document)throw new Error("IDBWrapper requires a window with a document");return IDBWrapper=function(n,r,o){"use strict";if(!n)throw new Error("Missing database name");this.db=null,this.transaction=null,this.DBNAME=n,this.DBVERSION=r,this.onUpgradeNeeded=o,this.close=function(){this.db.close()},this.connect=function(){var n=this,r=new t(function(t,r){var o=n.DBVERSION?e.open(n.DBNAME,n.DBVERSION):e.open(n.DBNAME);o.onerror=function(e){return r(e.target.error.message)},o.onsuccess=function(e){return n.db=e.target.result,t()},o.onupgradeneeded=function(e){n.db=e.target.result,"function"==typeof n.onUpgradeNeeded&&n.onUpgradeNeeded()}});return r},this.reconnect=function(e){return this.DBVERSION=this.db.version+1,this.onUpgradeNeeded=e,this.close(),this.connect()},this.createStore=function(e){if(!e.name)throw new Error("The name of the store is not specified to create it");if(!this.db.objectStoreNames.contains(e.name)){var t,n=this.db.createObjectStore(e.name,{keyPath:"id",autoIncrement:!0});if(Array.isArray(e.fields))for(e.fields.unshift({code:"id",uniq:!0}),t=0;t<e.fields.length;t+=1)"string"==typeof e.fields[t].code&&n.createIndex(e.fields[t].code,e.fields[t].code,{unique:"boolean"!=typeof e.fields[t].uniq?e.fields[t].uniq:!1})}},this.createNewStore=function(e){return this.reconnect(function(){this.createStore(e)})},this.deleteStore=function(e){var t=this;return t.reconnect(function(){"string"==typeof e&&t.db.deleteObjectStore(e)})},this.getStoresList=function(){var e,t=[];for(e=0;e<this.db.objectStoreNames.length;e+=1)t.push(this.db.objectStoreNames[e]);return t},this.store=function(e){var n=null;if(!e)throw new Error("The name of the repository is not specified when you try to connect to the repository");return this.transaction=this.db.transaction(e,"readwrite"),n=this.transaction.objectStore(e),{add:function(e){return new t(function(t,r){var o=n.add(e);o.onsuccess=function(){return t()},o.onerror=function(e){return r(e.target.error.message)}})},get:function(){return new t(function(e,t){var r;r=n.getAll(),r.onsuccess=function(t){return e(t.target.result||[])},r.onerror=function(e){return t(e.target.error.message)}})},where:function(e){var r=null,o="next",i=n.index(e);return{equal:function(e){return r=window.IDBKeyRange.only(e),this},more:function(e){return r=window.IDBKeyRange.lowerBound(e,!0),this},less:function(e){return r=window.IDBKeyRange.upperBound(e,!0),this},moreOrEqual:function(e){return r=window.IDBKeyRange.lowerBound(e),this},lessOrEqual:function(e){return r=window.IDBKeyRange.upperBound(e),this},order:function(e){return o="desc"===e?"prev":"next",this},get:function(){return new t(function(e,t){var n=[],s=null,u=i.openCursor(r,o);u.onsuccess=function(t){var r=t.target.result;return r?(s=r.value,s.id=r.primaryKey,n.push(s),r.advance(1),void 0):e(n)},u.onerror=function(e){return t(e.target.error.message)}})}}},update:function(e,r){return new t(function(t,o){e||o("You must specify an id to update the record"),"object"!=typeof r&&o("Data for updating is not an object"),r.id=Number(e);var i=n.put(r);i.onsuccess=function(e){return t(e)},i.onerror=function(e){return o(e.target.error.message)}})},"delete":function(e){return new t(function(t,r){e||r("You must specify an id to delete the record");var o=n["delete"](e);o.onsuccess=function(){return t()},o.onerror=function(e){return r(e.target.error.message)}})}}}},IDBWrapper.prototype.deleteDatabase=function(e){"use strict";var n=this;return new t(function(t,r){e||r("Missing database name"),n.db&&n.close();var o=window.indexedDB.deleteDatabase(e);o.onsuccess=function(){return t()},o.onblocked=function(e){return r("Delete database error")},o.onerror=function(e){return r(e.target.error.message)}})},IDBWrapper});
